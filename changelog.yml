version: 2.1
description: Run a the changelog configurator

orbs:
  changelog:
    executors:
      changelog:
        docker:
          - image: circleci/ruby:2.5-node
    jobs:
      changelog:
        parameters:
          repo:
            description: The GitHub repository
            type: string
          org:
            description: The GitHub username
            type: string
          gitemail:
            description: The git committer's email
            type: string
            default: office+ci@ory.sh
          gituersname:
            description: The git committer's username
            type: string
            default: ORY Continuous Integration
        executor: changelog
        steps:
          - checkout
          - run: gem install github_changelog_generator -v 1.14.3
          - run: sudo npm i -g doctoc
          - restore_cache:
              keys:
                - changelog-v1
          - run: github_changelog_generator -u <<parameters.org>> -p <<parameters.repo>> -o CHANGELOG.md --token $GITHUB_TOKEN --cache-file /tmp/github_changelog_generator
          - save_cache:
              key: changelog-v1
              paths:
                - "/tmp/github_changelog_generator"
          - run: doctoc CHANGELOG.md
          - run: git config --global user.email "office+ci@ory.sh"
          - run: git config --global user.name "ORY Continuous Integration"
          - run: git add CHANGELOG.md
          - run: git pull -ff
          - run: |
              git commit -m "docs: Incorporates changes from version $(git describe --tags) [ci skip]" -- CHANGELOG.md
          - run: git remote rm origin
          - run: git remote add origin https://arekkas:$GITHUB_TOKEN@github.com/<<parameters.org>>/<<parameters.repo>>.git
          - run: git push origin HEAD:master



workflows:
  main:
    jobs:
      - my-orb/myjob
